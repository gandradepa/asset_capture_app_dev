{% extends "base.html" %}
{% block title %}Capture Asset Photos{% endblock %}

{% block content %}
  <div class="rounded-xl shadow-md w-full overflow-hidden bg-white p-6">
    <h2 class="text-xl font-bold text-center mb-4">Capture Asset Photos</h2>

    {# --- Existing uploads as thumbnails with quick delete and labels --- #}
    <div>
      <h3 class="text-sm font-semibold mb-2">Current uploads</h3>
      {% if existing_files %}
        <div id="uploadsGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-3 mb-6">
          {% for f in existing_files %}
            <div class="border rounded-lg p-2 text-center" data-filename="{{ f.filename }}">
              <img src="{{ f.url }}" alt="{{ f.filename }}" class="w-full h-24 object-cover rounded mb-2">
              <!-- Human-readable title -->
              <div class="text-xs font-semibold text-gray-800">{{ f.label }}</div>
              <!-- Small base string for reference -->
              <div class="text-[11px] text-gray-500 truncate mb-2">{{ f.base }}</div>
              <button type="button"
                      class="delete-btn w-full text-red-700 border border-red-600 rounded py-1 text-xs hover:bg-red-50">
                Delete
              </button>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p id="uploadsEmpty" class="text-sm text-gray-500 mb-6">No uploads yet.</p>
        <div id="uploadsGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-3 mb-6"></div>
      {% endif %}
    </div>

    <form method="POST" action="{{ url_for('submit') }}" enctype="multipart/form-data" class="space-y-4">
      <input type="hidden" name="qr_code" value="{{ qr_code }}">
      <input type="hidden" name="building_code" value="{{ building_code }}">
      <input type="hidden" name="asset_type" value="{{ asset_type }}">

      {% if asset_type == 'Mechanical' %}
        {% set fields = [
          ('image_0','Asset Plate'),
          ('image_1','UBC Tag'),
          ('image_2','Main Asset Photo'),
          ('image_3','Technical Safety BC')
        ] %}
      {% else %}
        {% set fields = [
          ('image_0','Asset Plate'),
          ('image_1','UBC Tag'),
          ('image_2','Main Asset Photo')
        ] %}
      {% endif %}

      {% for name,label in fields %}
      <div>
        <label class="block text-sm font-medium">{{ label }}</label>
        <div class="flex items-center gap-2">
          <input type="file" name="{{ name }}" accept="image/*" capture="environment"
                 onchange="previewImage(event, 'preview_{{ loop.index }}')" class="mt-1">
          <a href="javascript:void(0)" onclick="resetFile('{{ name }}','preview_{{ loop.index }}')"
             class="text-xs text-blue-600 underline ml-2">Retake</a>
        </div>
        <img id="preview_{{ loop.index }}" class="mt-2 hidden rounded border" alt="Preview {{ loop.index }}">
      </div>
      {% endfor %}

      <div class="flex gap-2 pt-2">
        <a href="{{ url_for('start', building_code=building_code, asset_type=asset_type) }}"
           class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded text-center hover:bg-gray-300">Back</a>
        <button type="submit" class="flex-1 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
          Submit
        </button>
      </div>
    </form>
  </div>

  <script>
    function previewImage(event, previewId) {
      const img = document.getElementById(previewId);
      const file = event.target.files[0];
      if (!file) { img.classList.add('hidden'); img.src=''; return; }
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; img.classList.remove('hidden'); };
      reader.readAsDataURL(file);
    }
    function resetFile(inputName, previewId) {
      const input = document.getElementsByName(inputName)[0];
      input.value = '';
      const img = document.getElementById(previewId);
      img.classList.add('hidden'); img.src='';
    }

    // Quick delete for existing uploads
    (function () {
      const grid = document.getElementById('uploadsGrid');
      if (!grid) return;

      grid.addEventListener('click', async (e) => {
        if (!e.target.classList.contains('delete-btn')) return;
        const card = e.target.closest('[data-filename]');
        const filename = card.getAttribute('data-filename');
        if (!confirm(`Delete "${filename}"?`)) return;

        try {
          const res = await fetch('{{ url_for("delete_upload") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              qr_code: '{{ qr_code }}',
              building_code: '{{ building_code }}',
              asset_type: '{{ asset_type }}',
              filename
            })
          });
          const data = await res.json();
          if (data.ok) {
            card.remove();
            const gridNow = document.querySelectorAll('#uploadsGrid [data-filename]').length;
            if (gridNow === 0) {
              const empty = document.getElementById('uploadsEmpty');
              if (empty) empty.classList.remove('hidden');
              else {
                const p = document.createElement('p');
                p.id = 'uploadsEmpty';
                p.className = 'text-sm text-gray-500 mb-6';
                p.textContent = 'No uploads yet.';
                grid.parentNode.insertBefore(p, grid);
              }
            }
          } else {
            alert('Delete failed: ' + (data.error || 'unknown error'));
          }
        } catch (err) {
          alert('Delete error: ' + err);
        }
      });
    })();
  </script>
{% endblock %}
