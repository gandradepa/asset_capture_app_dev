{% extends "base.html" %}
{% block title %}UBC Asset Capture â€” Start{% endblock %}

{% block content %}
  <div class="rounded-xl shadow-md w-full overflow-hidden bg-white p-6">
    <h1 class="text-xl font-bold text-center mb-4">Scan QR Code</h1>

    <div id="qr-reader" class="w-full mb-4"></div>

    <div class="flex gap-2 mb-3">
      <button type="button" id="startScanner"
              class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
        Start Scanner
      </button>
      <button type="button" id="stopScanner"
              class="flex-1 bg-gray-200 text-gray-800 py-2 rounded hover:bg-gray-300">
        Stop
      </button>
    </div>

    <div id="qr_status" class="text-sm text-center text-gray-700 mb-2">
      Grant camera permission to scan.
    </div>
    <div id="qr_inline_alert" class="mb-4"></div>

    <details class="mb-4">
      <summary class="cursor-pointer text-sm text-blue-700">Enter QR manually (fallback)</summary>
      <input type="text" id="manual_qr" class="mt-2 w-full border rounded px-3 py-2"
             placeholder="Type or paste QR code / URL" />
      <button type="button" id="useManual"
              class="mt-2 w-full bg-slate-600 text-white py-2 rounded hover:bg-slate-700">
        Use this value
      </button>
    </details>

    <form method="POST" action="{{ url_for('capture') }}" class="space-y-4" id="startForm">
      <input type="hidden" id="qr_code" name="qr_code" value="">
      <input type="hidden" id="overwrite" name="overwrite" value="0">

      <div>
        <label for="building_code" class="block text-sm font-medium mb-1">Select Building</label>
        <select name="building_code" id="building_code" class="w-full border rounded px-3 py-2" required>
          <option value="">-- Select Building --</option>
          {% for b in building_options %}
            <option value="{{ b.code }}" {% if building_code and b.code == building_code %}selected{% endif %}>
              {{ b.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="asset_type" class="block text-sm font-medium mb-1">Asset Type</label>
        <select name="asset_type" id="asset_type" class="w-full border rounded px-3 py-2" required>
          <option value="Mechanical" {% if asset_type == 'Mechanical' %}selected{% endif %}>Mechanical</option>
          <option value="Electrical" {% if asset_type == 'Electrical' %}selected{% endif %}>Electrical</option>
          <option value="Backflow"  {% if asset_type == 'Backflow'  %}selected{% endif %}>Backflow</option>
        </select>
      </div>

      <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
        Continue
      </button>
    </form>
  </div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    (function () {
      const qrReaderElem = document.getElementById("qr-reader");
      const startBtn = document.getElementById("startScanner");
      const stopBtn  = document.getElementById("stopScanner");
      const qrStatus = document.getElementById("qr_status");
      const qrInput  = document.getElementById("qr_code");
      const overwriteInput = document.getElementById("overwrite");
      const form     = document.getElementById("startForm");
      const manual   = document.getElementById("manual_qr");
      const useManualBtn = document.getElementById("useManual");
      const inlineAlert = document.getElementById("qr_inline_alert");

      let html5QrCode = null;
      let scanning = false;

      function clearInlineAlert() { inlineAlert.innerHTML = ""; }
      function showInlineAlert(options) {
        inlineAlert.innerHTML = `
          <div class="border rounded-lg p-3 bg-yellow-50 border-yellow-200">
            <div class="text-sm text-yellow-900 mb-2">${options.message}</div>
            <div class="flex gap-2">
              <button type="button" id="alertContinue"
                      class="flex-1 bg-yellow-600 text-white py-1.5 rounded hover:bg-yellow-700 text-sm">
                Continue & replace
              </button>
              <button type="button" id="alertCancel"
                      class="flex-1 bg-gray-200 text-gray-800 py-1.5 rounded hover:bg-gray-300 text-sm">
                Scan another
              </button>
            </div>
          </div>`;
        document.getElementById("alertContinue").onclick = options.onContinue;
        document.getElementById("alertCancel").onclick = options.onCancel;
      }

      function extractNumericId(text) {
        if (!text) return "";
        const matches = String(text).match(/\d{6,}/g);
        if (!matches) return "";
        let best = matches[0];
        for (const m of matches) if (m.length >= best.length) best = m;
        return best;
      }

      async function checkExists(numericId) {
        try {
          const res = await fetch(`{{ url_for('api_check_qr') }}?qr=${encodeURIComponent(numericId)}`);
          const data = await res.json();
          return !!(data && data.exists);
        } catch (err) {
          console.warn("QR existence check failed:", err);
          return false;
        }
      }

      async function handleExistence(numericId) {
        overwriteInput.value = "0";
        const exists = await checkExists(numericId);
        if (!exists) { clearInlineAlert(); return true; }
        showInlineAlert({
          message: "This Asset already exists. Would you like to continue?",
          onContinue: () => {
            overwriteInput.value = "1";
            qrStatus.textContent = "Overwrite enabled. You will replace existing data for this asset.";
            clearInlineAlert();
          },
          onCancel: () => {
            qrInput.value = "";
            qrStatus.textContent = "QR cleared. Please scan another code.";
            clearInlineAlert();
          }
        });
        return false;
      }

      function libraryReady() { return typeof Html5Qrcode !== "undefined"; }

      async function setQrValueAndCheck(raw) {
        clearInlineAlert();
        const id = extractNumericId(raw) || (raw || "").trim();
        if (!id) { qrInput.value = ""; qrStatus.textContent = "âš ï¸ Could not extract a numeric ID. Try again."; return; }
        qrInput.value = id;
        qrStatus.textContent = "âœ… QR captured: " + id;
        await handleExistence(id);
      }

      startBtn.addEventListener("click", async function () {
        try {
          if (!libraryReady()) { qrStatus.textContent = "âš ï¸ QR library failed to load."; return; }
          if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
          const cameras = await Html5Qrcode.getCameras();
          if (!cameras || !cameras.length) { qrStatus.textContent = "âš ï¸ No cameras found."; return; }
          await html5QrCode.start(
            cameras[0].id,
            { fps: 10, qrbox: 250 },
            async (decodedText) => {
              await setQrValueAndCheck(decodedText);
              html5QrCode.stop().then(() => { scanning = false; qrReaderElem.innerHTML = ""; });
            },
            () => {}
          );
          scanning = true;
          qrStatus.textContent = "ðŸ“· Scanning... hold the QR steadily.";
        } catch (err) {
          qrStatus.textContent = "âš ï¸ Unable to access camera: " + err;
        }
      });

      stopBtn.addEventListener("click", function () {
        if (html5QrCode && scanning) {
          html5QrCode.stop().then(() => {
            scanning = false; qrReaderElem.innerHTML = ""; qrStatus.textContent = "Scanner stopped."; clearInlineAlert();
          });
        }
      });

      useManualBtn.addEventListener("click", async function () {
        if (!manual.value.trim()) { alert("Please type a QR value first."); return; }
        await setQrValueAndCheck(manual.value);
      });

      form.addEventListener("submit", async function (e) {
        let v = (qrInput.value || "").trim();
        if (!/^\d{6,}$/.test(v)) {
          const id = extractNumericId(v);
          if (id) { qrInput.value = id; v = id; } else {
            e.preventDefault(); alert("âš ï¸ Please scan a QR code that contains a numeric ID."); return;
          }
        }
        if (overwriteInput.value !== "1") {
          const exists = await checkExists(v);
          if (exists) {
            e.preventDefault();
            showInlineAlert({
              message: "This Asset already exists. Would you like to continue?",
              onContinue: () => { overwriteInput.value = "1"; qrStatus.textContent = "Overwrite enabled."; clearInlineAlert(); form.submit(); },
              onCancel: () => { qrInput.value = ""; qrStatus.textContent = "QR cleared. Please scan another code."; clearInlineAlert(); }
            });
          }
        }
      });
    })();
  </script>
{% endblock %}
